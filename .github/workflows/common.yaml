name: ðŸ§ª common
on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths: ["common/**", ".github/workflows/common.yaml"]
  pull_request:
    paths: ["common/**", ".github/workflows/common.yaml"]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  clippy:
    name: ðŸ“Ž clippy
    runs-on: ubuntu-24.04
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
      - name: ðŸ¦€ Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: clippy
      - name: ðŸ“Ž Run Clippy
        run: cargo clippy -p common --locked --all-targets -- -D warnings

  fmt:
    name: ðŸŽ¨ fmt
    runs-on: ubuntu-24.04
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
      - name: ðŸ¦€ Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: rustfmt
      - name: ðŸŽ¨ Check formatting
        run: cargo fmt -p common --check

  build:
    name: ðŸ”¨ build
    runs-on: ubuntu-24.04
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
      - name: ðŸ¦€ Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
      - name: ðŸ”¨ Build
        run: cargo build -p common --locked

  test:
    name: âœ… test
    runs-on: ubuntu-24.04
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
      - name: ðŸ¦€ Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: llvm-tools-preview
      - name: ðŸ“¦ Install cargo-llvm-cov
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-llvm-cov
      - name: âœ… Run tests with coverage
        run: cargo llvm-cov -p common --no-default-features --locked --codecov --output-path coverage.json --ignore-filename-regex 'create\.rs'
      - name: ðŸ“¤ Upload coverage
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage.json
          flags: rust
