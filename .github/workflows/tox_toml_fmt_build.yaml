name: ğŸ“¦ tox-toml-fmt
on:
  workflow_dispatch:
    inputs:
      release:
        description: "ğŸš€ Release (semver bump)?"
        required: true
        default: "no"
        type: choice
        options: ["no", patch, minor, major]
  push:
    branches: ["main"]
    paths: ["common/**", "tox-toml-fmt/**", ".github/workflows/tox_toml_fmt_build.yaml"]
  pull_request:
    paths: ["common/**", "tox-toml-fmt/**", ".github/workflows/tox_toml_fmt_build.yaml"]
  schedule:
    - cron: "0 8 * * *"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event.inputs.release == 'no' || github.event.inputs.release == null }}

permissions:
  contents: read

jobs:
  bump:
    name: ğŸ”– bump
    runs-on: ubuntu-24.04
    permissions:
      pull-requests: read
    outputs:
      version: ${{ steps.v.outputs.version }}
      changelog: ${{ steps.v.outputs.changelog }}
    steps:
      - name: ğŸ¦€ Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
      - name: ğŸ“¦ Install cargo-edit
        uses: baptiste0928/cargo-install@v3
        with:
          crate: cargo-edit
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v6
      - name: ğŸ”– Bump version
        run: cargo set-version -p tox-toml-fmt --bump '${{ github.event.inputs.release == 'no' || github.event.inputs.release == null && 'patch' || github.event.inputs.release }}'
      - name: ğŸ“¦ Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-dependency-glob: "tasks/changelog.py"
      - name: ğŸ“ Generate changelog
        id: v
        run: uv run tasks/changelog.py tox-toml-fmt "${{ github.event.number }}" "${{ github.event.pull_request.base.sha }}"
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
      - name: ğŸ Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.14"
      - name: ğŸ¨ Run pre-commit
        uses: tox-dev/action-pre-commit-uv@v1
        continue-on-error: true
      - name: ğŸ‘€ Show changes
        run: git diff HEAD -u
      - name: ğŸ“¤ Upload source
        uses: actions/upload-artifact@v6
        with:
          name: source
          path: |
            .
            !.git
          compression-level: 9
          retention-days: 1
          if-no-files-found: "error"

  linux:
    name: ğŸ§ ${{ matrix.platform.target }}
    needs: [bump]
    runs-on: ${{ matrix.platform.runner }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          - { runner: ubuntu-24.04, target: x86_64, manylinux: "2_28", interpreter: "3.10 pypy3.10" }
          - { runner: ubuntu-24.04, target: x86_64-unknown-linux-musl, manylinux: musllinux_1_2 }
          - { runner: ubuntu-24.04, target: aarch64, manylinux: "2_28", zig: true }
          - { runner: ubuntu-24.04, target: riscv64gc-unknown-linux-gnu, manylinux: "2_31" }
    steps:
      - name: ğŸ“¥ Download source
        uses: actions/download-artifact@v7
        with:
          name: source
      - name: ğŸ”¨ Build wheels
        uses: PyO3/maturin-action@v1.49.4
        with:
          target: ${{ matrix.platform.target }}
          args: -m tox-toml-fmt/Cargo.toml --locked --release --out dist --interpreter ${{ matrix.platform.interpreter || '3.10' }} --target-dir target ${{ matrix.platform.zig && '--zig' || '' }}
          manylinux: ${{ matrix.platform.manylinux || 'auto' }}
          sccache: true
      - name: ğŸ“¤ Upload wheels
        uses: actions/upload-artifact@v6
        with:
          name: wheels-linux-${{ matrix.platform.target }}
          path: dist

  windows:
    name: ğŸªŸ ${{ matrix.platform.target }}
    needs: [bump]
    runs-on: ${{ matrix.platform.runner }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          - { runner: windows-2025, target: x64 }
    steps:
      - name: ğŸ“¥ Download source
        uses: actions/download-artifact@v7
        with:
          name: source
      - name: ğŸ Setup Python 3.10
        uses: actions/setup-python@v6
        with:
          python-version: "3.10"
          architecture: ${{ matrix.platform.target == 'x86' && 'x86' || 'x64' }}
      - name: ğŸ”¨ Build wheels
        uses: PyO3/maturin-action@v1.49.4
        with:
          target: ${{ matrix.platform.target }}
          args: -m tox-toml-fmt/Cargo.toml --locked --release --out dist --interpreter ${{ matrix.platform.interpreter || '3.10' }} --target-dir target
          sccache: true
      - name: ğŸ“¤ Upload wheels
        uses: actions/upload-artifact@v6
        with:
          name: wheels-windows-${{ matrix.platform.target }}
          path: dist

  macos:
    name: ğŸ ${{ matrix.platform.target }}
    needs: [bump]
    runs-on: ${{ matrix.platform.runner }}
    strategy:
      fail-fast: false
      matrix:
        platform:
          - { runner: macos-15, target: x86_64 }
          - { runner: macos-15, target: aarch64 }
    steps:
      - name: ğŸ“¥ Download source
        uses: actions/download-artifact@v7
        with:
          name: source
      - name: ğŸ”¨ Build wheels
        uses: PyO3/maturin-action@v1.49.4
        with:
          target: ${{ matrix.platform.target }}
          args: -m tox-toml-fmt/Cargo.toml --locked --release --out dist --interpreter "3.10 pypy3.10" --target-dir target
          sccache: true
      - name: ğŸ“¤ Upload wheels
        uses: actions/upload-artifact@v6
        with:
          name: wheels-macos-${{ matrix.platform.target }}
          path: dist

  sdist:
    name: ğŸ“¦ sdist
    needs: [bump]
    runs-on: ubuntu-24.04
    steps:
      - name: ğŸ“¥ Download source
        uses: actions/download-artifact@v7
        with:
          name: source
      - name: ğŸ“¦ Build sdist
        uses: PyO3/maturin-action@v1.49.4
        with:
          command: sdist
          args: -m tox-toml-fmt/Cargo.toml --out dist
      - name: ğŸ“¤ Upload sdist
        uses: actions/upload-artifact@v6
        with:
          name: wheels-sdist
          path: dist

  release:
    name: ğŸš€ release
    runs-on: ubuntu-24.04
    environment:
      name: release
      url: https://pypi.org/project/tox-toml-fmt/${{ needs.bump.outputs.version }}
    permissions:
      id-token: write
      contents: write
    if: github.event.inputs.release != 'no' && github.event.inputs.release != null && github.ref == 'refs/heads/main'
    needs: [bump, sdist, linux, macos, windows]
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v6
      - name: ğŸ“¥ Download source
        uses: actions/download-artifact@v7
        with:
          name: source
          path: .
      - name: ğŸ‘€ Show changes
        run: git diff HEAD -u
      - name: ğŸ’¾ Commit release
        run: |
          git config --global user.name 'Bernat Gabor'
          git config --global user.email 'gaborbernat@users.noreply.github.com'
          git commit -am "Release tox-toml-fmt ${{needs.bump.outputs.version}}"
      - name: ğŸ·ï¸ Tag release
        run: git tag tox-toml-fmt/${{needs.bump.outputs.version}}
      - name: ğŸ“¥ Download wheels
        uses: actions/download-artifact@v7
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: "true"
      - name: ğŸ‘€ Show wheels
        run: ls -lth dist
      - name: ğŸš€ Publish to PyPI
        uses: PyO3/maturin-action@v1.49.4
        with:
          command: upload
          args: --non-interactive --skip-existing dist/*
      - name: ğŸ“¢ Create GitHub release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git pull --rebase origin main
          git push
          git push --tags
          gh release create "tox-toml-fmt/${{needs.bump.outputs.version}}" \
              --title="tox-toml-fmt/${{needs.bump.outputs.version}}" --verify-tag \
            --notes "$(cat << 'EOM'
          ${{ needs.bump.outputs.changelog }}
          EOM
          )"
