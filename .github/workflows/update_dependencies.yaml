name: ğŸ“¦ update dependencies
on:
  workflow_dispatch:
  schedule:
    - cron: "0 8 * * *"

permissions:
  contents: write
  pull-requests: write

jobs:
  python:
    name: ğŸ python
    runs-on: ubuntu-24.04
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v6

      - name: ğŸ¦€ Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: ğŸ Setup uv
        uses: astral-sh/setup-uv@v7

      - name: ğŸ§ª Install tox
        run: uv tool install tox --with tox-uv

      - name: ğŸ“ Generate README.rst
        run: |
          tox r -e readme -c pyproject-fmt
          tox r -e readme -c tox-toml-fmt

      - name: â¬†ï¸ Bump dependencies
        run: |
          uvx bump-deps-index -i https://pypi.org/simple -f pyproject.toml tox.toml
          uvx bump-deps-index -i https://pypi.org/simple -f pyproject-fmt/pyproject.toml pyproject-fmt/tox.toml
          uvx bump-deps-index -i https://pypi.org/simple -f tox-toml-fmt/pyproject.toml tox-toml-fmt/tox.toml
          uvx bump-deps-index -i https://pypi.org/simple -f toml-fmt-common/pyproject.toml toml-fmt-common/tox.toml

      - name: ğŸ”§ Fix workspace deps
        run: sed -i 's/toml-fmt-common>=.*/toml-fmt-common",/' pyproject-fmt/pyproject.toml tox-toml-fmt/pyproject.toml

      - name: ğŸ”’ Update lock file
        run: uv lock --upgrade

      - name: ğŸ¨ Run prek
        run: uvx prek run --all-files || true

      - name: ğŸ”€ Create Pull Request
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.RELEASE_TOKEN }}
          commit-message: "Update Python dependencies"
          title: "Update Python dependencies"
          body: |
            Automated Python dependency update.

            - Bumped dependency version constraints in `pyproject.toml` and `tox.toml`
            - Updated `uv.lock` with latest compatible versions
          branch: update-python-dependencies
          delete-branch: true

  rust:
    name: ğŸ¦€ rust
    runs-on: ubuntu-24.04
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v6

      - name: ğŸ¦€ Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: â¬†ï¸ Update git dependencies
        run: |
          TOMBI_TAG=$(gh api repos/tombi-toml/tombi/releases/latest --jq .tag_name)
          sed -i "s/tombi-toml\/tombi\", tag = \"v[^\"]*\"/tombi-toml\/tombi\", tag = \"$TOMBI_TAG\"/" Cargo.toml
        env:
          GH_TOKEN: ${{ github.token }}

      - name: â¬†ï¸ Update Cargo.toml dependencies
        run: |
          cargo install cargo-edit
          cargo upgrade --incompatible

      - name: â¬†ï¸ Update Cargo.lock
        run: cargo update

      - name: ğŸ”€ Create Pull Request
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.RELEASE_TOKEN }}
          commit-message: "Update Rust dependencies"
          title: "Update Rust dependencies"
          body: |
            Automated Rust dependency update.

            - Updated `Cargo.lock` with latest compatible versions
          branch: update-rust-dependencies
          delete-branch: true
